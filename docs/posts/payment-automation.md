---
title: ìˆ˜ê¸° ê²°ì œ ìë™í™” â€” í† ìŠ¤í˜ì´ë¨¼ì¸  ì •ê¸°ê²°ì œì™€ PG ì¶”ìƒí™” ì„¤ê³„
description: CMS ìˆ˜ê¸° ê²°ì œë¥¼ í† ìŠ¤í˜ì´ë¨¼ì¸  ì •ê¸°ê²°ì œë¡œ ìë™í™”í•˜ê³ , PGì‚¬ êµì²´ë¥¼ ëŒ€ë¹„í•œ ê³µí†µ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì„¤ê³„í•œ ì´ì•¼ê¸°
tags: [NestJS, TypeScript, í† ìŠ¤í˜ì´ë¨¼ì¸ , ì´ë‹ˆì‹œìŠ¤, PG, ê²°ì œìë™í™”]
---

# ìˆ˜ê¸° ê²°ì œ ìë™í™” â€” í† ìŠ¤í˜ì´ë¨¼ì¸  ì •ê¸°ê²°ì œì™€ PG ì¶”ìƒí™” ì„¤ê³„

ë§¤ì›” 1ì¼, 15ì¼, ë§ì¼. ì´ ì„¸ ë‚ ì§œì—ëŠ” ìš´ì˜íŒ€ì´ CMS ê´€ë¦¬ì í˜ì´ì§€ë¥¼ ì—´ì—ˆë‹¤. ì¹´ë“œ ì •ë³´ë¥¼ ì§ì ‘ ì…ë ¥í•˜ê³ , ê²°ì œ ë²„íŠ¼ì„ ëˆŒë €ë‹¤. ê³ ê° ìˆ˜ë§Œí¼ ë°˜ë³µí–ˆë‹¤. í•œ ë²ˆì— 30ë¶„, í•œ ë‹¬ì— ì„¸ ë²ˆ.

ê²°ì œê°€ ëëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ CMS í™”ë©´ì„ ë‹¤ì‹œ ì—´ì–´ë´ì•¼ í–ˆë‹¤. ì´ë ¥ì´ ì—†ì—ˆë‹¤. ê³ ê°ì´ "ì € ê²°ì œ ëë‚˜ìš”?"ë¼ê³  ë¬¼ì–´ì˜¤ë©´ ê´€ë¦¬ì í˜ì´ì§€ë¥¼ ì§ì ‘ í™•ì¸í•˜ëŠ” ìˆ˜ë°–ì— ì—†ì—ˆë‹¤. ê²°ì œ ì‹¤íŒ¨ê°€ ë‚˜ë„ ë‹¤ìŒ ì‘ì—… ë•Œ ê°€ì„œì•¼ ì•Œì•˜ë‹¤. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ìˆ˜ê¸°ë¡œ ê¸°ë¡í•˜ë˜ ê²°ì œ ì´ë ¥ì€ ì–¸ì œë‚˜ í•œ ë°•ì ëŠ¦ì—ˆë‹¤.

ì´ êµ¬ì¡°ë¥¼ ë°”ê¾¸ëŠ” ê²Œ ëª©í‘œì˜€ë‹¤.

## PGì‚¬ëŠ” ê²°êµ­ ë°”ë€ë‹¤

ì„¤ê³„ë¥¼ ì‹œì‘í•˜ë©´ì„œ "í† ìŠ¤í˜ì´ë¨¼ì¸ ë§Œ ì“¸ ê²ƒ"ì´ë¼ëŠ” ì „ì œë¥¼ ë²„ë ¸ë‹¤. PGì‚¬ëŠ” ìˆ˜ìˆ˜ë£Œ, ì •ì‚° ì£¼ê¸°, ê¸°ëŠ¥ ì§€ì› ë²”ìœ„ì— ë”°ë¼ ë°”ë€ë‹¤. ì‹¤ì œë¡œ ì´ë‹ˆì‹œìŠ¤ ë„ì…ì´ ì˜ˆì •ë¼ ìˆì—ˆê³ , ê·¸ê²Œ ì•„ë‹ˆë”ë¼ë„ ê°™ì€ íŒë‹¨ì„ í–ˆì„ ê²ƒì´ë‹¤.

í† ìŠ¤í˜ì´ë¨¼ì¸ ì— ì§ì ‘ ì˜ì¡´í•˜ëŠ” ì½”ë“œë¥¼ ì§œë©´, PGì‚¬ë¥¼ ë°”ê¿€ ë•Œ ê²°ì œ ê´€ë ¨ ì½”ë“œ ì „ì²´ë¥¼ ëœ¯ì–´ê³ ì³ì•¼ í•œë‹¤. ì¸í„°í˜ì´ìŠ¤ í•˜ë‚˜ë¥¼ ì‚¬ì´ì— ë‘ë©´, ê·¸ ë¹„ìš©ì´ Adapter í•˜ë‚˜ êµ¬í˜„ìœ¼ë¡œ ì¤„ì–´ë“ ë‹¤. ì²˜ìŒë¶€í„° êµì²´ ê°€ëŠ¥í•œ êµ¬ì¡°ë¡œ ë§Œë“œëŠ” ê²Œ ë‚«ë‹¤ëŠ” ê±´ ê²°ì œ ì½”ë“œë¥¼ í•œ ë²ˆì´ë¼ë„ ê³ ì³ë³¸ ì‚¬ëŒì´ë¼ë©´ ì•ˆë‹¤.

```mermaid
flowchart TB
    SERVICE[PaymentService] --> INTERFACE[IPgAdapter\nê³µí†µ ì¸í„°í˜ì´ìŠ¤]
    INTERFACE --> TOSS[TossPaymentsAdapter]
    INTERFACE --> INICIS[InicisAdapter]
    INTERFACE --> FUTURE[ë¯¸ë˜ì˜ PGì‚¬ Adapter]

    SERVICE --> HISTORY[(payment_history\nê²°ì œ ì´ë ¥ í…Œì´ë¸”)]
    SERVICE --> SLACK[Slack ì•Œë¦¼]
```

## ê³µí†µ ì¸í„°í˜ì´ìŠ¤ ì •ì˜

```typescript
export interface IPgAdapter {
  /**
   * ì •ê¸°ê²°ì œ ë¹Œë§í‚¤ ë°œê¸‰
   * PGì‚¬ë§ˆë‹¤ ë°œê¸‰ ë°©ì‹ì´ ë‹¤ë¥´ì§€ë§Œ, ê²°ê³¼ëŠ” ë™ì¼í•œ BillingKey í˜•íƒœë¡œ ë°˜í™˜
   */
  issueBillingKey(params: IssueBillingKeyParams): Promise<BillingKey>;

  /** ë¹Œë§í‚¤ë¡œ ê²°ì œ ì‹¤í–‰ */
  charge(params: ChargeParams): Promise<PaymentResult>;

  /** ê²°ì œ ì·¨ì†Œ */
  cancel(params: CancelParams): Promise<CancelResult>;

  /** ê²°ì œ ìƒíƒœ ì¡°íšŒ */
  getStatus(paymentKey: string): Promise<PaymentStatus>;
}

export interface PaymentResult {
  paymentKey: string;       // PGì‚¬ ê²°ì œ ê³ ìœ  í‚¤
  orderId: string;
  amount: number;
  status: 'DONE' | 'FAILED' | 'CANCELED';
  approvedAt: Date;
  pgProvider: 'TOSS' | 'INICIS';
}
```

### í† ìŠ¤í˜ì´ë¨¼ì¸  Adapter

```typescript
@Injectable()
export class TossPaymentsAdapter implements IPgAdapter {
  async charge(params: ChargeParams): Promise<PaymentResult> {
    const response = await this.httpClient.post(
      `https://api.tosspayments.com/v1/billing/${params.billingKey}`,
      {
        customerKey: params.customerId,
        amount: params.amount,
        orderId: params.orderId,
        orderName: params.orderName,
      },
      {
        headers: {
          Authorization: `Basic ${Buffer.from(`${this.secretKey}:`).toString('base64')}`,
        },
      },
    );

    return {
      paymentKey: response.data.paymentKey,
      orderId: response.data.orderId,
      amount: response.data.totalAmount,
      status: response.data.status === 'DONE' ? 'DONE' : 'FAILED',
      approvedAt: new Date(response.data.approvedAt),
      pgProvider: 'TOSS',
    };
  }
}
```

### ì´ë‹ˆì‹œìŠ¤ Adapter

ì´ë‹ˆì‹œìŠ¤ëŠ” í† ìŠ¤í˜ì´ë¨¼ì¸ ì™€ API ìŠ¤í™ì´ ì™„ì „íˆ ë‹¤ë¥´ë‹¤. ì¸ì¦ ë°©ì‹(HMAC ì„œëª…), ìš”ì²­ íŒŒë¼ë¯¸í„°, ì‘ë‹µ í˜•íƒœê°€ ëª¨ë‘ ë‹¤ë¥´ë‹¤. í•˜ì§€ë§Œ `IPgAdapter` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê¸° ë•Œë¬¸ì— `PaymentService`ëŠ” ì–´ëŠ PGì‚¬ì¸ì§€ ì‹ ê²½ ì“°ì§€ ì•ŠëŠ”ë‹¤.

```typescript
@Injectable()
export class InicisAdapter implements IPgAdapter {
  async charge(params: ChargeParams): Promise<PaymentResult> {
    const timestamp = Date.now().toString();
    const signature = this.generateHmac(params, timestamp);

    const response = await this.httpClient.post(
      'https://iniapi.inicis.com/api/v1/billing',
      {
        mid: this.merchantId,
        timestamp,
        signature,
        billkey: params.billingKey,
        price: params.amount,
        goodname: params.orderName,
      },
    );

    // ì´ë‹ˆì‹œìŠ¤ ì‘ë‹µì„ ê³µí†µ í˜•íƒœë¡œ ë³€í™˜
    return {
      paymentKey: response.data.tid,        // ì´ë‹ˆì‹œìŠ¤ëŠ” tid
      orderId: params.orderId,
      amount: params.amount,
      status: response.data.resultCode === '0000' ? 'DONE' : 'FAILED',
      approvedAt: new Date(),
      pgProvider: 'INICIS',
    };
  }
}
```

---

## ì •ê¸°ê²°ì œ ìë™í™” íë¦„

```mermaid
sequenceDiagram
    participant CRON as NestJS Cron
    participant SERVICE as PaymentService
    participant PG as PgAdapter (Toss/Inicis)
    participant DB as payment_history
    participant SLACK as Slack

    CRON->>SERVICE: ì •ê¸°ê²°ì œ ì‹¤í–‰ (ë§¤ì›” 1ì¼, 15ì¼, ë§ì¼)
    SERVICE->>DB: ê²°ì œ ëŒ€ìƒ ê³ ê° ì¡°íšŒ (í™œì„± êµ¬ë…)

    loop ê³ ê°ë³„ ì²˜ë¦¬
        SERVICE->>PG: charge(billingKey, amount)
        alt ì„±ê³µ
            PG-->>SERVICE: PaymentResult { status: DONE }
            SERVICE->>DB: INSERT payment_history (SUCCESS)
            SERVICE->>SLACK: âœ… ê²°ì œ ì™„ë£Œ ì•Œë¦¼
        else ì‹¤íŒ¨
            PG-->>SERVICE: PaymentResult { status: FAILED }
            SERVICE->>DB: INSERT payment_history (FAILED)
            SERVICE->>SLACK: ğŸ”´ ê²°ì œ ì‹¤íŒ¨ ì•Œë¦¼ (ê³ ê°ëª…, ê¸ˆì•¡, ì‚¬ìœ )
        end
    end
```

## Audit êµ¬ì¡° â€” ê²°ì œ ì´ë ¥ í…Œì´ë¸”

```typescript
@Entity('payment_history')
export class PaymentHistory {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  customerId: string;

  @Column()
  orderId: string;

  @Column('decimal', { precision: 10, scale: 2 })
  amount: number;

  @Column({ type: 'enum', enum: ['SUCCESS', 'FAILED', 'CANCELED'] })
  status: PaymentStatus;

  @Column({ type: 'enum', enum: ['TOSS', 'INICIS'] })
  pgProvider: PgProvider;

  @Column({ nullable: true })
  pgPaymentKey: string;       // PGì‚¬ ê²°ì œ í‚¤ (í™˜ë¶ˆÂ·ì¡°íšŒìš©)

  @Column({ nullable: true })
  failureReason: string;      // ì‹¤íŒ¨ ì‚¬ìœ 

  @Column('jsonb')
  rawResponse: object;        // PGì‚¬ ì›ë³¸ ì‘ë‹µ (ë””ë²„ê¹…ìš©)

  @CreateDateColumn()
  createdAt: Date;
}
```

`rawResponse`ì— PGì‚¬ ì›ë³¸ ì‘ë‹µì„ í†µì§¸ë¡œ ì €ì¥í•œë‹¤. ë‚˜ì¤‘ì— "ì´ ê²°ì œê°€ ì™œ ì‹¤íŒ¨í–ˆëŠ”ì§€" ë””ë²„ê¹…í•  ë•Œ, PGì‚¬ ì‘ë‹µ ì›ë¬¸ì´ ìˆìœ¼ë©´ ì›ì¸ íŒŒì•…ì´ í›¨ì”¬ ë¹ ë¥´ë‹¤. ìŠ¤í† ë¦¬ì§€ ë¹„ìš©ë³´ë‹¤ ë””ë²„ê¹… ì‹œê°„ì´ ë” ë¹„ì‹¸ë‹¤.

## PGì‚¬ ì„ íƒ ë¡œì§

```typescript
@Injectable()
export class PaymentService {
  constructor(
    @Inject('TOSS_PG') private readonly tossAdapter: IPgAdapter,
    @Inject('INICIS_PG') private readonly inicisAdapter: IPgAdapter,
  ) {}

  private selectAdapter(customer: Customer): IPgAdapter {
    switch (customer.pgProvider) {
      case 'TOSS': return this.tossAdapter;
      case 'INICIS': return this.inicisAdapter;
      default: throw new Error(`ì§€ì›í•˜ì§€ ì•ŠëŠ” PGì‚¬: ${customer.pgProvider}`);
    }
  }

  async chargeSubscription(customer: Customer): Promise<void> {
    const adapter = this.selectAdapter(customer);

    try {
      const result = await adapter.charge({
        billingKey: customer.billingKey,
        amount: customer.subscriptionAmount,
        orderId: generateOrderId(),
        orderName: 'êµ¬ë… ê²°ì œ',
        customerId: customer.id,
      });

      await this.paymentHistoryRepo.save({
        customerId: customer.id,
        orderId: result.orderId,
        amount: result.amount,
        status: 'SUCCESS',
        pgProvider: result.pgProvider,
        pgPaymentKey: result.paymentKey,
        rawResponse: result,
      });

    } catch (error) {
      await this.paymentHistoryRepo.save({
        customerId: customer.id,
        status: 'FAILED',
        failureReason: error.message,
        rawResponse: error.response?.data ?? {},
      });

      await this.slackNotifier.alert({
        title: 'ì •ê¸°ê²°ì œ ì‹¤íŒ¨',
        message: `ê³ ê°: ${customer.name}, ê¸ˆì•¡: ${customer.subscriptionAmount}ì›`,
        severity: 'error',
        metadata: { reason: error.message, pgProvider: customer.pgProvider },
      });
    }
  }
}
```

ìƒˆ PGì‚¬ë¥¼ ì¶”ê°€í•  ë•Œ `PaymentService` ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ê±´ë“œë¦¬ì§€ ì•ŠëŠ”ë‹¤. `NewPgAdapter implements IPgAdapter`ë¥¼ êµ¬í˜„í•˜ê³ , ëª¨ë“ˆì— providerë¥¼ ë“±ë¡í•˜ê³ , `selectAdapter()`ì— case í•œ ì¤„ì„ ì¶”ê°€í•˜ë©´ ëì´ë‹¤. `payment_history` í…Œì´ë¸” êµ¬ì¡°, Slack ì•Œë¦¼ ë¡œì§, Cron ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” ê·¸ëŒ€ë¡œë‹¤.

---

## Audit ì—†ì´ ê²°ì œ ìš´ì˜ì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤

ìë™í™” ì´í›„ ìˆ˜ê¸° ì‘ì—…ì€ ì‚¬ë¼ì¡Œë‹¤. ê²°ì œ ì´ë ¥ì€ DBì— ìë™ìœ¼ë¡œ ìŒ“ì´ê³ , ì‹¤íŒ¨ëŠ” Slackìœ¼ë¡œ ì¦‰ì‹œ ì˜¬ë¼ì˜¨ë‹¤. ê³ ê°ì´ "ì € ê²°ì œ ëë‚˜ìš”?"ë¼ê³  ë¬¼ì–´ì˜¤ë©´ DBë¥¼ ì¡°íšŒí•˜ë©´ ëœë‹¤.

ê·¸ëŸ°ë° ì´ êµ¬ì¡°ì—ì„œ ì§„ì§œ ì¤‘ìš”í•œ ê±´ Cronì´ë‚˜ Adapterê°€ ì•„ë‹ˆë¼ `payment_history`ë‹¤. ê²°ì œ ì´ë ¥ì´ ì—†ìœ¼ë©´ ê³ ê° ë¶„ìŸ, ì •ì‚° ê²€ì¦, ì¥ì•  ë””ë²„ê¹… ëª¨ë‘ ë§‰ë§‰í•´ì§„ë‹¤. ì–´ë–¤ PGì‚¬ë¥¼ ì“°ë“ , ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ê²°ì œë¥¼ ì²˜ë¦¬í•˜ë“ , ëª¨ë“  ê²°ì œ í–‰ìœ„ëŠ” ê¸°ë¡ìœ¼ë¡œ ë‚¨ì•„ì•¼ í•œë‹¤. ì´ê±´ ì„¤ê³„ ì›ì¹™ì´ ì•„ë‹ˆë¼ ìš´ì˜ ê²½í—˜ì—ì„œ ë‚˜ì˜¨ í™•ì‹ ì´ë‹¤.
